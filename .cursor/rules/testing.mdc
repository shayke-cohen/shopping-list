---
description: Testing requirements and conventions
globs: ["**/*.test.*", "**/*.spec.*", "**/tests/**", "**/__tests__/**"]
alwaysApply: false
---

# Testing Rules

## ALWAYS Do

1. **Write tests with new features**
   - Every new function with logic needs a unit test
   - Every new API endpoint needs an integration test
   - Every bug fix needs a regression test

2. **Run tests before committing**
   ```bash
   npm run lint && npm test
   ```

3. **Write regression tests for bugs**
   - First write a failing test that reproduces the bug
   - Then fix the bug and verify test passes
   - Include bug reference in test name: `it('should handle null - fixes #123')`

4. **Test edge cases**
   - Empty inputs
   - Null/undefined values
   - Boundary conditions
   - Error scenarios

5. **Keep tests fast**
   - Mock external services
   - Use test databases
   - Avoid sleep/timeouts

## NEVER Do

1. ❌ **Skip tests to save time** - Technical debt accumulates
2. ❌ **Commit with failing tests** - Fix or skip with reason
3. ❌ **Write tests that depend on order** - Tests must be independent
4. ❌ **Test implementation details** - Test behavior, not internals
5. ❌ **Leave console.log in tests** - Clean up debug statements

## Test Structure

```typescript
describe('[Component/Function name]', () => {
  // Setup
  beforeEach(() => {
    // Common setup
  });

  describe('[method/scenario]', () => {
    it('should [expected behavior] when [condition]', () => {
      // Arrange
      const input = {...};
      
      // Act
      const result = functionUnderTest(input);
      
      // Assert
      expect(result).toEqual(expected);
    });
  });
});
```

## Naming Convention

```typescript
// Pattern: should [expected behavior] when [condition]
it('should return empty array when input is null', () => {});
it('should throw ValidationError when email is invalid', () => {});
it('should create user when all fields are valid', () => {});
```

## Mocking Guidelines

- Mock external APIs and services
- Mock database for unit tests (use real DB for integration)
- Mock time-dependent functions
- Don't mock the code under test

```typescript
// Good - mock external dependency
jest.mock('../services/api');
const mockApi = api as jest.Mocked<typeof api>;
mockApi.fetchUser.mockResolvedValue({ id: '1', name: 'Test' });

// Bad - mock the function being tested
jest.mock('../utils/calculate'); // Don't do this if testing calculate
```

## Coverage Requirements

| Metric | Minimum | Target |
|--------|---------|--------|
| Line coverage | 70% | 85% |
| Branch coverage | 60% | 80% |
| Critical paths | 100% | 100% |
